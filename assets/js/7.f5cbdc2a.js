(window.webpackJsonp=window.webpackJsonp||[]).push([[7],{187:function(e,t,o){"use strict";o.r(t);var n=o(0),r=Object(n.a)({},function(){var e=this,t=e.$createElement,o=e._self._c||t;return o("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[o("h1",{attrs:{id:"how-to-monitor-power-consumption-of-a-socket"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#how-to-monitor-power-consumption-of-a-socket","aria-hidden":"true"}},[e._v("#")]),e._v(" How to monitor power consumption of a socket")]),e._v(" "),o("h2",{attrs:{id:"introduction"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#introduction","aria-hidden":"true"}},[e._v("#")]),e._v(" Introduction")]),e._v(" "),o("p",[e._v("This tutorial presents how to assemble a formula (RAPL-formula) and a sensor\n(HWPC-sensor) to build a power meter that monitor the power consumption of each\nCPU socket.")]),e._v(" "),o("p",[e._v("First of all, we describe the power meter that we want to build. Then, we\ndescribe how to deploy the power meter's component and how to connect\nthem. Each component could be deployed with docker or directly by installing it\non the system.")]),e._v(" "),o("h2",{attrs:{id:"compatible-architecture"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#compatible-architecture","aria-hidden":"true"}},[e._v("#")]),e._v(" Compatible Architecture")]),e._v(" "),o("p",[e._v("The power meter will use hardware counters that exist only on Intel CPU with\nSandy Bridge architecture or higher. The power meter can't be used without\ntheses counters.")]),e._v(" "),o("h2",{attrs:{id:"power-meter-description"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#power-meter-description","aria-hidden":"true"}},[e._v("#")]),e._v(" Power meter description")]),e._v(" "),o("p",[e._v("Power meter estimations are based on the Running Average Power Limit (RAPL)\ntechnology. RAPL provide a set of hardware counters that report data about the\ncurrent energy consumption of each CPU socket. The power meter use the\nHWPC-sensor to collect these data and send them to the RAPL-formula to compute\nthe current energy consumption of monitored sockets.")]),e._v(" "),o("p",[e._v("Each component of the power meter could be hosted on a different machine. In\nthis tutorial, we assume that each component are hosted on the same machine.")]),e._v(" "),o("h2",{attrs:{id:"data-and-database"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#data-and-database","aria-hidden":"true"}},[e._v("#")]),e._v(" Data and database")]),e._v(" "),o("p",[e._v("As explained "),o("router-link",{attrs:{to:"/howto/powerapi_howitworks.html#power-meter-architecture"}},[e._v("here")]),e._v(" The power\nmeter need two mongoDB databases to connect the formula to the sensor and to\nstore the power consumption information computed by the formula.")],1),e._v(" "),o("p",[e._v("We assume that this two databases are hosted on the same mongoDB instance but\ndifferent instances could be used for each database. In the rest of its\ntutorial, the URI of the mongoDB instance will be "),o("code",[e._v("mongo://ADDR")])]),e._v(" "),o("p",[e._v("The first database (that connect the formula and the sensor) will be called\n"),o("code",[e._v("connection_db")]),e._v(" and the data will be store on the "),o("code",[e._v("hwrep")]),e._v(" collection.")]),e._v(" "),o("p",[e._v("The second database (that store power consumption computed by the formula) will\nbe called "),o("code",[e._v("output_db")]),e._v(" and data will be stored on the "),o("code",[e._v("power_consumption")]),e._v("\ncollection.")]),e._v(" "),o("h2",{attrs:{id:"get-power-meter-result"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#get-power-meter-result","aria-hidden":"true"}},[e._v("#")]),e._v(" Get power meter result")]),e._v(" "),o("p",[e._v("To access to the power consumption information computed by the power meter just\nconnect a mongo client to the mongoDB instance and retrieve the data of the\n"),o("code",[e._v("power_consumption")]),e._v(" collection of the "),o("code",[e._v("output_db")]),e._v(" database.")]),e._v(" "),o("p",[e._v("Power information data are structured as this json format :")]),e._v(" "),o("pre",[o("code",[e._v('{\n    "_id" : XXX # MongoDB object identifier (string)\n    "timestamp" : YYY # timestamp of the power measure (iso date)\n    "metadata" : {\n            "socket" : "N", # socket identifier (int)\n    },\n    "power" : Z.ZZZ # power consumption expressed in watts (float)\n}\n')])]),e._v(" "),o("p",[e._v("For example to display a power consumption report with the mongo client :")]),e._v(" "),o("pre",[o("code",[e._v("mongo ADDR\nuse output_db\ndb.power_consumption.findOne()\n")])]),e._v(" "),o("h2",{attrs:{id:"deployment-with-docker"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#deployment-with-docker","aria-hidden":"true"}},[e._v("#")]),e._v(" Deployment with docker")]),e._v(" "),o("p",[e._v("This section present how to deploy and connect each component of the power\nmeter with docker. You will see how to :")]),e._v(" "),o("ul",[o("li",[e._v("deploy a mongoDB instance in a docker container")]),e._v(" "),o("li",[e._v("deploy the HWPC-sensor in a docker container and connect it to the mongoDB instance")]),e._v(" "),o("li",[e._v("deploy the RAPL-formula in a docker container and connect it to the mongoDB instance")])]),e._v(" "),o("h3",{attrs:{id:"setup-docker-environment"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#setup-docker-environment","aria-hidden":"true"}},[e._v("#")]),e._v(" Setup docker environment")]),e._v(" "),o("p",[e._v("Download components image :")]),e._v(" "),o("pre",[o("code",[e._v("docker pull powerapi/hwpc-sensor\ndocker pull powerapi/rapl-formula\ndocker pull mongo\n")])]),e._v(" "),o("p",[e._v("Setup a docker network that will be used to connect each containers")]),e._v(" "),o("pre",[o("code",[e._v("docker network create powerapi\n")])]),e._v(" "),o("h3",{attrs:{id:"launch-the-different-component"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#launch-the-different-component","aria-hidden":"true"}},[e._v("#")]),e._v(" Launch the different component")]),e._v(" "),o("p",[e._v("Launch the mongoDB instance :")]),e._v(" "),o("pre",[o("code",[e._v("docker run -td --name powerapi-mongo --net=powerapi -p 27017:27017 mongo\n")])]),e._v(" "),o("p",[e._v("Launch the sensor :")]),e._v(" "),o("pre",[o("code",[e._v('docker run --net=powerapi --privileged --name powerapi-sensor -td -v /sys:/sys -v /var/lib/docker/containers:/var/lib/docker/containers:ro -v /tmp/powerapi-sensor-reporting:/reporting powerapi/hwpc-sensor -n "test-sensor" -r "mongodb" -U "mongodb://powerapi-mongo" -D "connection_db" -C "hwrep" -s "rapl" -o -e "RAPL_ENERGY_CORES" -e "RAPL_ENERGY_PKG" -e "RAPL_ENERGY_GPU"\n')])]),e._v(" "),o("p",[e._v("Launch the formula :")]),e._v(" "),o("pre",[o("code",[e._v("docker run -td --net=powerapi --name powerapi-formula powerapi/rapl-formula mongodb://powerapi-mongo connection_db hwrep mongodb://powerapi-mongo output_db power_consumption -s\n")])]),e._v(" "),o("h2",{attrs:{id:"deployment-without-docker"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#deployment-without-docker","aria-hidden":"true"}},[e._v("#")]),e._v(" Deployment without docker")]),e._v(" "),o("p",[e._v("This section present how to deploy and connect each component of the power\nmeter without docker, by installing each of them on the monitored machine. You\nwill see how to :")]),e._v(" "),o("ul",[o("li",[e._v("compile the HWPC-sensor and connect it to an existing mongoDB instance")]),e._v(" "),o("li",[e._v("install the RAPL-formula and connect it to an existing mongoDB instance")]),e._v(" "),o("li",[e._v("launch the sensor and the formula from the command line")])]),e._v(" "),o("h3",{attrs:{id:"prerequisites"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#prerequisites","aria-hidden":"true"}},[e._v("#")]),e._v(" Prerequisites")]),e._v(" "),o("ul",[o("li",[e._v("python 3.7")]),e._v(" "),o("li",[e._v("pip")]),e._v(" "),o("li",[e._v("a mongoDB instance runing and accessible from the address "),o("code",[e._v("mongodb://ADDR")])]),e._v(" "),o("li",[e._v("root privilege to launch the sensor")])]),e._v(" "),o("h3",{attrs:{id:"component-installation"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#component-installation","aria-hidden":"true"}},[e._v("#")]),e._v(" Component installation")]),e._v(" "),o("p",[e._v("install the sensor from sources")]),e._v(" "),o("pre",[o("code",[e._v("git clone https://github.com/powerapi-ng/hwpc-sensor.git\ncd hwpc-sensor\ncmake .\nmake\n")])]),e._v(" "),o("p",[e._v("install the RAPL-formula")]),e._v(" "),o("pre",[o("code",[e._v("pip3 install rapl-formula\n")])]),e._v(" "),o("h3",{attrs:{id:"launch-the-different-component-2"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#launch-the-different-component-2","aria-hidden":"true"}},[e._v("#")]),e._v(" Launch the different component")]),e._v(" "),o("p",[e._v("On the HWPC-sensor repository launch the sensor :")]),e._v(" "),o("pre",[o("code",[e._v('sudo ./hwpc-sensor -n "sensor" -r "mongodb" -U "mongodb://ADDR" -D "connection_db" -C "hwrep" -s "rapl" -o -e "RAPL_ENERGY_CORES" -e "RAPL_ENERGY_PKG" -e "RAPL_ENERGY_GPU" &\n')])]),e._v(" "),o("p",[e._v("launch the formula")]),e._v(" "),o("pre",[o("code",[e._v("python3 -m rapl_formula mongodb://ADDR connection_db hwrep mongodb://ADDR output_db power_consumption -s &\n")])])])},[],!1,null,null,null);t.default=r.exports}}]);